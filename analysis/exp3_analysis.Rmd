---
title: 'Experiment 3: ratings'
author: "George, Sama, and Mike"
date: "6/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(png)
library(grid)
library(ggplot2)
library(xtable)
require(here)
require(tidyverse)
require(tidyboot)
library(apa) # for generating APA-style text to report statistical tests
library(ggpubr)
require(gridExtra)
require(papaja)
require(kableExtra)
#require(qualtRics)
require(lmerTest)
require(ggpubr)
```

## Load Data

```{r pressure, echo=FALSE}
# Preregistration: https://docs.google.com/document/d/10iQ80L4K9PSa8yINPcjURj7xl10hXxzFHqtsS3DnsII/edit
load(file=here("paper/processed_data.RData")) 

int_dat <- read_csv(here("analysis/data_exp3/curiodrop V2 data - Intestingness.csv")) %>% 
  select(-`c1-14a`, -`c2-21a`, -`c3-22a`, -`c4-28a`, -`Q9`, -`Q8_1`)
lik_dat <- read_csv(here("analysis/data_exp3/curiodrop V2 data - Likelihood.csv")) %>%
  select(-`c1-14a`, -`c2-21a`, -`c3-22a`, -`c4-28a`, -`Q9`, -`Q8_1`)

new_col_names = unlist(int_dat[1,])
new_col_names[1:2] = c("Exclusion","SC0")
new_col_names[length(new_col_names)] = "subjID"
names(int_dat) = new_col_names
names(lik_dat) = new_col_names

int_dat = int_dat[2:nrow(int_dat),]
lik_dat = lik_dat[2:nrow(lik_dat),]
```

## Clean data

```{r}
# ToDo: count exclusions
int_dat <- int_dat %>% filter(is.na(Exclusion))

lik_dat <- lik_dat %>% filter(is.na(Exclusion))
```

# Pivot

```{r}
int_long <- int_dat %>% relocate(subjID) %>% # SC0 = score of catch trials
  pivot_longer(cols=4:ncol(int_dat), names_to="trial", values_to = "rating") %>%
  separate(col=trial, sep='-', into=c("drop","choice")) %>% select(-Exclusion) %>%
  rename(catch_trials_correct=`SC0`)

lik_long <- lik_dat %>% relocate(subjID) %>%
  pivot_longer(cols=4:ncol(int_dat), names_to="trial", values_to = "rating") %>%
  separate(col=trial, sep='-', into=c("drop","choice")) %>% select(-Exclusion) %>%
  filter(!is.na(rating))
```

## Data inspection

```{r}
table(int_long$subjID)
table(lik_long$subjID)

sum(is.na(int_long$rating))
sum(is.na(lik_long$rating))

```

## Summarize Choice Data

```{r}
#combos = adult_long %>% distinct(drop, choice, target)
distractors = c("trig prism", "trig prism", "octahedron", "sphere", "octahedron", "pyramid", "pyramid", "sphere", "sphere", "pyramid", "octahedron", "dumbbell", "dumbbell", "sphere", "pentagon", "cone", "octahedron", "dumbbell", "dumbbell", "cone")

adult_agg <- adult_long %>% group_by(drop, target, relation) %>%
  summarize(chose_target = mean(chose_target))

adult_agg$distractor = distractors
  # do we want raw counts for chose target vs. foil?
# for trial 1, 70% chose target (30% chose distractor)

child_agg <- child_long %>% group_by(drop, target, relation) %>%
  summarize(chose_target = mean(chose_target, na.rm=T)) 

child_agg$distractor = distractors
```

## Summarize Ratings Data

```{r}
lik_agg <- lik_long %>% mutate(rating = as.numeric(rating)) %>%
  group_by(drop, choice) %>%
  summarise(likelihood = mean(rating) - 1) # shift from 1-6 to 0-5

int_agg <- int_long %>% mutate(rating = as.numeric(rating)) %>%
  group_by(drop, choice) %>%
  summarise(interest = mean(rating) - 1) 
# also want ratings scaled 0-1?
```

## Merge ratings with adults' drop choices

```{r}
adult_agg <- adult_agg %>% left_join(lik_agg, by=c("drop"="drop", "target"="choice")) %>%
  rename(target_likelihood = likelihood) %>%
  left_join(lik_agg, by=c("drop"="drop", "distractor"="choice")) %>%
  rename(distractor_likelihood = likelihood)

adult_agg <- adult_agg %>% left_join(int_agg, by=c("drop"="drop", "target"="choice")) %>%
  rename(target_interest = interest) %>%
  left_join(int_agg, by=c("drop"="drop", "distractor"="choice")) %>%
  rename(distractor_interest = interest)

adult_agg <- adult_agg %>% 
  mutate(prop_target_likelihood = target_likelihood / (target_likelihood + distractor_likelihood),
         prop_target_interest = target_interest / (target_interest + distractor_interest))
```


## Merge ratings with children's drop choices

```{r}
child_agg <- child_agg %>% left_join(lik_agg, by=c("drop"="drop", "target"="choice")) %>%
  rename(target_likelihood = likelihood) %>%
  left_join(lik_agg, by=c("drop"="drop", "distractor"="choice")) %>%
  rename(distractor_likelihood = likelihood)

child_agg <- child_agg %>% left_join(int_agg, by=c("drop"="drop", "target"="choice")) %>%
  rename(target_interest = interest) %>%
  left_join(int_agg, by=c("drop"="drop", "distractor"="choice")) %>%
  rename(distractor_interest = interest)

child_agg <- child_agg %>% 
  mutate(prop_target_likelihood = target_likelihood / (target_likelihood + distractor_likelihood),
         prop_target_interest = target_interest / (target_interest + distractor_interest))
```


## Compare adult choices to ratings-derived proportions

Regression:

```{r}
m_lik <- lm(chose_target ~ relation * prop_target_likelihood, data=adult_agg)
m_int <- lm(chose_target ~ relation * prop_target_interest, data=adult_agg)
summary(m_lik) # Rsq = .63
summary(m_int) # Rsq = .84
anova(m_lik, m_int)


m3 <- lm(chose_target ~ relation * prop_target_likelihood + relation * prop_target_interest, data=adult_agg)
summary(m3)
```


```{r}
p1 <- adult_agg %>% ggplot(aes(x=chose_target, y=prop_target_likelihood, color=relation)) + geom_point() +
  xlab("Proportion of Adults Choosing Target") +
  ylab("Luce choice of Target vs. Distractor Likelihood") +
  xlim(0,1) + ylim(0,1) + theme_classic() +
  geom_abline(slope=1, intercept=0, linetype="dashed") +
  #stat_cor(method = "pearson") 
  stat_cor(inherit.aes = F, aes(x=chose_target, y=prop_target_likelihood, 
               label = paste(..rr.label.., sep = "~`,`~")))

p2 <- adult_agg %>% ggplot(aes(x=chose_target, y=prop_target_interest, color=relation)) + geom_point() +
  xlab("Proportion of Adults Choosing Target") +
  ylab("Luce choice of Target vs. Distractor Interestingness") +
  xlim(0,1) + ylim(0,1) + theme_classic() +
  geom_abline(slope=1, intercept=0, linetype="dashed") +
  #stat_cor(method = "pearson")
  stat_cor(inherit.aes = F, aes(x=chose_target, y=prop_target_interest, 
               label = paste(..rr.label.., sep = "~`,`~")))

ggpubr::ggarrange(p1, p2, nrow=1, common.legend = T)
```

## Compare children's choices to ratings-derived proportions

```{r}
p1 <- child_agg %>% ggplot(aes(x=chose_target, y=prop_target_likelihood, color=relation)) + geom_point() +
  xlab("Proportion of Adults Choosing Target") +
  ylab("Luce choice of Target vs. Distractor Likelihood") +
  xlim(0,1) + ylim(0,1) + theme_classic() +
  geom_abline(slope=1, intercept=0, linetype="dashed") +
  #stat_cor(method = "pearson") 
  stat_cor(inherit.aes = F, aes(x=chose_target, y=prop_target_likelihood, 
               label = paste(..rr.label.., sep = "~`,`~")))

p2 <- child_agg %>% ggplot(aes(x=chose_target, y=prop_target_interest, color=relation)) + geom_point() +
  xlab("Proportion of Adults Choosing Target") +
  ylab("Luce choice of Target vs. Distractor Interestingness") +
  xlim(0,1) + ylim(0,1) + theme_classic() +
  geom_abline(slope=1, intercept=0, linetype="dashed") +
  #stat_cor(method = "pearson")
  stat_cor(inherit.aes = F, aes(x=chose_target, y=prop_target_interest, 
               label = paste(..rr.label.., sep = "~`,`~")))

ggpubr::ggarrange(p1, p2, nrow=1, common.legend = T)
```


## Compare Likelihood Ratings to Physics Models

```{r}
load(here("models/model_data.RData")) # mdat, all_trials_mse, all_trials_mse_r, etc.
# load(here("models/support_probability_fit_df.RData")) 


#mdat %>% select(drop, target, relation, trial, support_probability) %>%
#  pivot_wider(id_cols=trial, names_from=trial, values_from=support_probability)
supp_prob <- mdat %>% select(drop, target, relation, support_probability) 

trials <- adult_agg %>% select(drop, target, distractor, relation) %>%
  left_join(supp_prob, by=c("drop","target","relation")) %>%
  rename(targ_supp_prob = support_probability) %>%
  left_join(supp_prob, by=c("drop"="drop", "distractor"="target", "relation"="relation")) %>%
  rename(dist_supp_prob = support_probability) %>%
  mutate(prop_target_supp = (targ_supp_prob) / (targ_supp_prob + dist_supp_prob + 1e-5))

adult_agg %>% left_join(trials %>% select(drop, target, distractor, relation, prop_target_supp)) %>%
  ggplot(aes(x=prop_target_supp, y=prop_target_likelihood, color=relation)) + geom_point(alpha=.8) +
  xlab("Proportion Target Support in Model") +
  ylab("Luce choice of Target vs. Distractor Likelihood") +
  xlim(0,1) + ylim(0,1) + theme_classic() +
  geom_abline(slope=1, intercept=0, linetype="dashed") +
  #stat_cor(method = "pearson") 
  stat_cor(inherit.aes = F, aes(x=prop_target_supp, y=prop_target_likelihood, 
               label = paste(..rr.label.., sep = "~`,`~")))
```



